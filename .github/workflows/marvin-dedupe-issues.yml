name: Marvin Issue Dedupe
description: Automatically dedupe GitHub issues using Marvin
on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to process for duplicate detection"
        required: true
        type: string

jobs:
  marvin-dedupe-issues:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Generate Marvin App token
        id: marvin-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.MARVIN_APP_ID }}
          private-key: ${{ secrets.MARVIN_APP_PRIVATE_KEY }}

      - name: Create dedupe prompt
        run: |
          mkdir -p /tmp/claude-prompts
          cat > /tmp/claude-prompts/dedupe-prompt.txt << 'EOF'
          Find up to 3 likely duplicate issues for GitHub issue ${{ github.repository }}/issues/${{ github.event.issue.number || inputs.issue_number }}.

          Follow these steps precisely:

          1. Use the Task tool to check if the GitHub issue (a) is closed, (b) does not need to be deduped (eg. because it is broad product feedback without a specific solution, or positive feedback), or (c) already has a duplicates comment that you made earlier. If so, do not proceed.

          2. Use the Task tool to view the GitHub issue, and ask the agent to return a summary of the issue

          3. Then, launch 3 parallel agents using the Task tool to search GitHub for duplicates of this issue, using diverse keywords and search approaches, using the summary from step 2

          4. Next, feed the results from steps 2 and 3 into another agent using the Task tool, so that it can filter out false positives that are likely not actually duplicates of the original issue. If there are no duplicates remaining, do not proceed.

          5. Finally, comment back on the issue with a list of up to three duplicate issues (or zero, if there are no likely duplicates)

          Notes for your agents:
          - Use `gh` to interact with GitHub, rather than web fetch
          - Do not use other tools, beyond `gh` and Task (eg. don't use other MCP servers, file edit, etc.)
          - Make a todo list first

          For your comment, follow this format precisely (example with 3 suspected duplicates):

          ---
          Found 3 possible duplicate issues:

          1. #123: Issue title here
          2. #456: Another issue title  
          3. #789: Third issue title

          This issue will be automatically closed as a duplicate in 3 days.

          - If your issue is a duplicate, please close it and ðŸ‘ the existing issue instead
          - To prevent auto-closure, add a comment or ðŸ‘Ž this comment

          ---
          EOF

      - name: Run Marvin dedupe command
        uses: anthropics/claude-code-base-action@beta
        with:
          model: claude-3-5-haiku-latest
          prompt_file: /tmp/claude-prompts/dedupe-prompt.txt
          allowed_tools: "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh api:*),Bash(gh issue comment:*),Task"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY_FOR_CI }}
          claude_env: |
            GH_TOKEN: ${{ steps.marvin-token.outputs.token }}
